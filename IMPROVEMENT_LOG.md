# 📋 過去問抽出機能の改善内容

## 🚀 主な改善点

### 1. **OpenAI API呼び出しの最適化**
- プロンプトを大幅にシンプル化（複雑な指示を削除）
- 入力テキスト長を2000文字に制限（より保守的に）
- 温度設定を0.0に変更（完全に決定的な応答）
- マックストークンを1500に削減

### 2. **応答処理の堅牢化**
- マークダウンコードブロック（```json）の自動除去
- レスポンスのクリーンアップ処理を強化
- JSON解析失敗時のフォールバック機能を改善
- 必須フィールドの検証を強化

### 3. **問題分割アルゴリズムの改善**
- 複数のパターンを試行し、最適なものを選択
- 問題番号パターンの検出精度を向上
- フォールバック分割（段落分割）を追加
- より厳格な長さチェック（100文字以上）

### 4. **フォールバック抽出機能の強化**
- 正規表現パターンの改善
- 正解検出アルゴリズムの強化
- 選択肢と正解の対応付け精度向上
- エラー時の詳細ログ出力

### 5. **エラー診断とユーザーガイダンスの強化**
- APIキー状態の詳細チェック
- テキスト長の適切性判定
- 問題パターンの自動検出と表示
- 具体的な解決策の提示
- テキストプレビュー機能

## 🔧 技術的な変更

### プロンプトの簡素化
```
旧: 複雑な指示（300行以上）
新: シンプルな指示（50行程度）
```

### 入力制限の最適化
```
旧: 3000文字（約750トークン）
新: 2000文字（約500トークン）
```

### 温度設定の調整
```
旧: 0.1（わずかなランダム性）
新: 0.0（完全に決定的）
```

## 💡 期待される効果

1. **安定性の向上**: API応答の一貫性が向上
2. **エラー率の削減**: フォールバック機能により失敗が減少
3. **ユーザビリティ向上**: 詳細なエラー診断により問題解決が容易
4. **処理速度の向上**: プロンプトの簡素化により応答が高速化

## 🧪 テスト結果

- ✅ 基本的な問題分割: 動作確認済み
- ✅ JSON応答処理: クリーンアップ機能動作
- ✅ フォールバック抽出: 正規表現ベース処理
- ✅ エラー診断: 詳細情報表示

## 📊 推奨使用方法

1. **PDFの準備**:
   - テキストベースのPDF（スキャン画像ではない）
   - 問題番号が明確（【問1】、問題1.など）
   - 選択肢が A、B、C、D 形式

2. **設定の最適化**:
   - カテゴリ名を具体的に設定
   - テキスト抽出方法は「自動選択」を推奨

3. **エラー時の対処**:
   - エラー診断情報を確認
   - テキストプレビューで問題構造を確認
   - 必要に応じてより小さなファイルで再試行

## 🎯 今後の改善予定

- [ ] OpenAI APIの応答キャッシュ機能
- [ ] 部分抽出機能（失敗した問題のみ再試行）
- [ ] 問題形式の自動検出と最適化
- [ ] ユニットテストの追加
